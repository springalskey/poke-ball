#!/usr/bin/env node

/**
 * 针对3级目录，create项目模块
 */
var program = require('commander');
var child_process = require('child_process');
var colors = require('colors');
var ejs = require('ejs');

var version = require('../package.json').version;
var FileTools = require('../tools/file.js').FileTools;
var DirTools = require('../tools/file.js').DirTools;
var path = require('../tools/path');
require('../tools/string');

program.parse(process.argv);

var args = program.args;
var moduleName = args[0];

var data = moduleName.split('/');
var length = data.length;

if (length != 3) {
  console.log('请输入完整的3级路径，如:kk views siri/order/list'.red);
  return;
}

var views = data[0];
var subViews = data[1];
var leafViews = data[2];

// 叶子模块存在，直接报错，return
if (DirTools.isExist(`${path.SEED_SRC_VIEWS}/${views}/${subViews}/${leafViews}`)) {
  console.log('该叶子模块已经存在'.red);
  return;
}

// 子模块存在(叶子模块不存在)，create:叶子模块
if (DirTools.isExist(`${path.SEED_SRC_VIEWS}/${views}/${subViews}`)) {
  createLeafViews(views, subViews, leafViews);
  return;
}

// 模块存在（子模块&叶子模块不存在），create:子模块&叶子模块
if (DirTools.isExist(`${path.SEED_SRC_VIEWS}/${views}`)) {
  createSubViews(views, subViews, leafViews);
  createLeafViews(views, subViews, leafViews);
  return;
}

// 模块&子模块&叶子模块不存在，create:模块&子模块&叶子模块
if (!DirTools.isExist(`${path.SEED_SRC_VIEWS}/${views}`)) {
  createViews(views, subViews, leafViews);
  createSubViews(views, subViews, leafViews);
  createLeafViews(views, subViews, leafViews);
  return;
}

// create模块
function createViews(views, subViews, leafViews) {
  DirTools.mkDir(`${path.SEED_SRC_VIEWS}/${views}`);
  console.log(`create ${path.SEED_SRC_VIEWS}/${views} success`.green);

  var content = FileTools.readFile(`${path.CLI_TEM_VIEWS}/menu.vue`).toString();
  content = content.replace(/{views}/g, views);
  content = content.replace(/{subViews}/g, subViews);
  content = content.replace(/{leafViews}/g, leafViews);
  content = content.replace(/{upViews}/g, leafViews.firstUppserCase());
  FileTools.createFile(`${path.SEED_SRC_VIEWS}/layout/menus/${views}Menu.vue`, content);
  console.log(`create ${path.SEED_SRC_VIEWS}/layout/menus/${views}Menu.vue success`.green);

  var content = FileTools.readFile(`${path.CLI_TEM_VIEWS}/index.js`).toString();
  content = content.replace(/{views}/g, views);
  content = content.replace(/{subViews}/g, subViews);
  content = content.replace(/{leafViews}/g, leafViews);
  content = content.replace(/{upLeafViews}/g, leafViews.firstUppserCase());
  FileTools.createFile(`${path.SEED_SRC_VIEWS}/${views}/index.js`, content);
  console.log(`create ${path.SEED_SRC_VIEWS}/${views}/index.js success`.green);

  updateRootRoute(views, subViews, leafViews);

  updateLayout(views, subViews, leafViews);

  return;
}
// create子模块
function createSubViews(views, subViews, leafViews) {
  DirTools.mkDir(`${path.SEED_SRC_VIEWS}/${views}/${subViews}`);
  console.log(`create ${path.SEED_SRC_VIEWS}/${views}/${subViews} success`.green);

  return;
}

// create叶子模块
function createLeafViews(views, subViews, leafViews) {
  DirTools.mkDir(`${path.SEED_SRC_VIEWS}/${views}/${subViews}/${leafViews}`);
  console.log(`create ${path.SEED_SRC_VIEWS}/${views}/${subViews}/${leafViews} success`.green);

  var content = FileTools.readFile(`${path.CLI_TEM_VIEWS}/leafViews/list.js`).toString();
  content = content.replace(/{moduleName}/g, views);
  FileTools.createFile(`${path.SEED_SRC_VIEWS}/${views}/${subViews}/${leafViews}/${leafViews}.js`, content);
  console.log(`create ${path.SEED_SRC_VIEWS}/${views}/${subViews}/${leafViews}/${leafViews}.js success`.green);

  var content = FileTools.readFile(`${path.CLI_TEM_VIEWS}/leafViews/index.vue`).toString();
  var config = require('../template/views/config.json');
  config.moduleName = leafViews;
  content = renderHtml(content, config);
  content = content.replace(/{moduleName}/g, leafViews);
  FileTools.createFile(`${path.SEED_SRC_VIEWS}/${views}/${subViews}/${leafViews}/index.vue`, content);
  console.log(`create ${path.SEED_SRC_VIEWS}/${views}/${subViews}/${leafViews}/index.vue success`.green);

  return;
}

// ejs渲染模版
function renderHtml(str, config) {
  var data = ejs.compile(str)({
    config: config
  });
  data = data.replace(/^\s*[\r\n]/gm, "");
  return data;
}

// 在添加一个大模块时，修改src/views/index.js路由文件
function updateRootRoute(views, subViews, leafViews) {
  var content = FileTools.readFile(`${path.SEED_SRC_VIEWS}/index.js`).toString();
  content = content.replace(/\nexport default \[/,
    `\nimport ${views.firstUppserCase()}Menu from './layout/menus/${views}Menu';
import ${views.firstUppserCase()}Routes from './${views}';

export default [
  {
    path: '/${views}',
    name: '${views}',
    component: ${views.firstUppserCase()}Menu,
    children: ${views.firstUppserCase()}Routes
  },`);
  FileTools.createFile(`${path.SEED_SRC_VIEWS}/index.js`, content);
}

// 在添加一个叶子模块时：修改 src/views/siri/index.js 模块路由文件
function updateModuleRoute() {

}

// 在添加一个大模块时： 修改 src/views/layout/index.vue 布局文件
function updateLayout(views, subViews, leafViews) {
  var content = FileTools.readFile(`${path.SEED_SRC_VIEWS}/layout/index.vue`).toString();
  content = content.replace(/<\/el-menu>/,
    `  <el-menu-item index="/${views}"><i class="el-icon-message"></i>${views}</el-menu-item>
      <\/el-menu>`);
  FileTools.createFile(`${path.SEED_SRC_VIEWS}/layout/index.vue`, content);
}
